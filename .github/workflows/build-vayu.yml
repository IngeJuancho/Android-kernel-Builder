name: Build Vayu Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel branch'
        required: true
        default: 'lineage-21'
        type: choice
        options:
          - lineage-20
          - lineage-21
          - main
      
      compiler:
        description: 'Compiler'
        required: true
        default: 'proton-clang'
        type: choice
        options:
          - proton-clang
          - aosp-clang

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Free Disk Space ðŸ§¹
      run: |
        echo "Liberando espacio..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        df -h
        
    - name: Setup Build Environment ðŸ“¦
      run: |
        echo "Instalando dependencias..."
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ca-certificates ccache curl flex \
          git libelf-dev libssl-dev python3 wget zip zlib1g-dev
        echo "Entorno listo!"
        
    - name: Setup ccache âš¡
      run: |
        echo "Configurando ccache..."
        mkdir -p ~/.ccache
        echo "max_size = 5G" > ~/.ccache/ccache.conf
        echo "compression = true" >> ~/.ccache/ccache.conf
        ccache -s
        
    - name: Clone Kernel Source ðŸ“¥
      run: |
        echo "Clonando kernel de Vayu..."
        git clone --depth=1 \
          https://github.com/AnymoreProject/android_kernel_vayu \
          -b ${{ inputs.kernel_branch }} kernel
        cd kernel
        echo "Kernel clonado: $(git log -1 --oneline)"
        
    - name: Get Kernel Version ðŸ“‹
      id: version
      run: |
        cd kernel
        VERSION=$(make kernelversion 2>/dev/null | cut -d'-' -f1)
        COMMIT=$(git rev-parse --short HEAD)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
        echo "VersiÃ³n: ${VERSION} (${COMMIT})"
        
    - name: Clone Proton Clang ðŸ”¨
      if: inputs.compiler == 'proton-clang'
      run: |
        echo "Descargando Proton Clang..."
        git clone --depth=1 https://github.com/kdrag0n/proton-clang toolchain
        echo "Compilador listo: $(toolchain/bin/clang --version | head -n1)"
        
    - name: Clone AOSP Clang ðŸ”¨
      if: inputs.compiler == 'aosp-clang'
      run: |
        echo "Descargando AOSP Clang..."
        mkdir -p toolchain
        wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
        tar -xzf clang-r487747c.tar.gz -C toolchain
        rm clang-r487747c.tar.gz
        echo "AOSP Clang listo"
        
    - name: Build Kernel ðŸš€
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export KBUILD_BUILD_USER="GitHub"
        export KBUILD_BUILD_HOST="Actions"
        export PATH="$GITHUB_WORKSPACE/toolchain/bin:$PATH"
        
        # Configurar
        make O=out vayu_defconfig
        
        # Compilar
        make -j$(nproc --all) O=out \
             CC=clang \
             CROSS_COMPILE=aarch64-linux-gnu- \
             LD=ld.lld
        
        # Verificar resultado
        ls out/arch/arm64/boot/
        
    - name: Create Zip Package ðŸ“¦
      run: |
        cd kernel/out/arch/arm64/boot
        # El kernel compilado para este dispositivo es Image.gz
        if [ -f "Image.gz" ]; then
          mv Image.gz Image.gz-dtb
          zip -r9 Vayu-Kernel-${{ inputs.kernel_branch }}-${{ steps.version.outputs.commit }}.zip Image.gz-dtb
        else
          echo "Error: El archivo del kernel compilado no se encontrÃ³."
          exit 1
        fi
        
    - name: Upload Artifact ðŸ“¤
      uses: actions/upload-artifact@v4
      with:
        name: Vayu-Kernel-${{ inputs.kernel_branch }}-${{ steps.version.outputs.commit }}
        path: kernel/out/arch/arm64/boot/*.zip